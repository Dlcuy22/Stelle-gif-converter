// main.go
// turns videos into cursed WebP animations. your laptop might scream. use at your own risk 😭

// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▒▒▒▓▓▓▓██▓▓▒▒▒▒▒▒▒▒░░░░░░░░░▒▒▒▒▓▓▓▓▓▓▓▓▒▓▓▒▓▒▓████▓▓▓▓▓▓▓▓▓▓▓
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▓▓▓██▓▓▓██████▓▓████████▓▓▓▓░░░░░░░░░░░░░░░░░░░░▒▒░▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▓██████████████████████████████▓▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▒▒▓▓▓▓▓
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▓███████████████████████████████████▓░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▓
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒██████████████████████████████████████▓▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▓
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒████████████████▓▓▓▓▓▓█████████████████▓▓▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▓▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█████▓██████▓▓▓▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▓▓███████▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓██████████▓▓▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▓▓█▓████▓▓▒▒▒▒▒▒▒▒▒▒░░▒▒▒▒▒▒▒▒▒▒▒▓▓▓████████▓▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▓▓█▒▒█▓▓▓▒▒░▒▒▒▒▒▒▒░░░░░░░░▒▒▒▒▒▒▒▒▓▓▓▓████████▓▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▓█▓▒▓▓▓▓▒░▒▒▒▒▒▒▒▒▒░░░░░░░░▒▒▒▒▒▒▒▒▒▓▓▓▓▓████▓██▓░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▓██▒▒▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░░▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓███▒░▓▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▓▒░▒▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓███▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▓█▓▒▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓██▓▒▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒▒▓████▓▓▓▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▓▓▓▓▓██████▓█▓░░░░░░░░░░░░░░░░░░░░░░░░░░░
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▓▓▒▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓█▓▓▓▓█▒▓▓▓░░░░░░░░░░░░░░░░░░░░░░░░░░
// ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▓▓▓▓▓▒▓▓▓▓▓▒▒▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▓█▓▓▓▓▒░░░░░░░░░░░░░░░░░░░░░░░░░
// ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░▒▒▒▒▒▒░░░▓▓▓█▓▒▒▓▒▓▓▓▓▓▓▓▓▓███▓▓▓▓▒▒▒▒▒▒▓▓▓████▓▓▓▓▓▓█▓▓▓▓▒▒▒▓█▓▓▓▓▒░░░░░░░░░░░░░░░░░░░░░░░░░
// ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓██▓▓▓▓▓▓▓▓▓▓▓▓▒▒▓▓▓███▓▓▒▒▒▒▒▓████▓▓▒▒▓▓▓██▓▓▓█▓▓▓▓██▓▓█▒░░░░░░░░░░░░░░░░░░░░░░░░░
// ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓███▓▒▒░▒▒▓███▓▓▓▓▓▓▓▓█▓▓▓▓█▓▓▓▓█████▒░░░░░░░░░░░░░░░░░░░░░░░░░
// ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒░▒▒▒▓▓▓▓▓▓▓███▓▓▓▓▓▓██████████▒▒░░░░░░░░░░░░░░░░░░░░░░░░
// ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓████████▓▒▒▒▓▓████▓▓▒▒▒▒▒▒░░▒▒▒▒▒▒▒▓▓▓▓▓▒▒▒▓▓▓▓█████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░
// ██████████████████████████████████████████████▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓██████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒░░░
// ██████████████████████████████████████████████▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓██████████▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒░░
// ██████████████████████████████████████████████▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▒▒▒▒▒▒▓▓▓▓██████████▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░
// ███████████████████████████████████████████████▓▓▓▓▓▓▒▒▒▒▒▓▓▓██▓▓▓▓█████▓▒▓▓▓▓▓█████████████▓▒▒▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░
// ████████████████████████████████████████████████████▓▓▓▒▒▒▓████████████▓▓▓▓▓▓██████████████▓▓▓▒▒▒▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒░░
// ███████████████████████████████████████████████▓▓████▓▓▓▓▓▓▓▓▓▓▓▓██▓▓▓▓▓▓▓▓███▓▓██████▓▓▓▓▓▓▓▓▓▒▒▒▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒░░
// ████████████████████████████████████████████████▓▓▓▓▓▓██▓▓▓▒▒▒▒▒▒▒▒▒▓▓▓▓▓▓██▓▓▓███████▓▓▓▓▓▓▓▓▓▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒░▒▒
// ████████████████████████████████████████████████████▓▓▒▓▓████▓▓▓▓▓▓▓▓▓▓▓▓█▓▓▓▓██████████▓▓▓▓▓▓▓▓▓▒▒░▒▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒
// ███████████████████████████████████████████▓▓▓▓███████▓▓▒▓▓▒▒▒▒░░░░░▒▒▒▒▓▓▓▓▓█████████████▓▓▓▓▓▓▓▒▒▒░▒▒▒▓▓▒▒▓▓▓▓▓▓▒▒▓▒▒▒
// ████████▓██████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███▓▓▓█▓██▓▓▓▒▒▒▓████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███████████████▓▓▓▓▓▓▓▒▒▒▒░░░░░▒▒▒▒▒▒▓▓▓▓░▒▒
// ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▓▓▓███████▓▓▓▓▓▓███████▓▓▓▓▓▓██████████████████▓▓▓▓▒▒▒▒▒▒▒▒░░░░░░░░▒▒▒▒░▒▒
// ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▓▓▒▒▒▒▓▒▒▒▒▓▓▓███████▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▓▓█████████████████████▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░▒▒░▒▒
// ▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▓▓▓▓▓▒▒▒▒▓▓▓▓▒▒▓▓▒▓▓▓▓▓████████▓▓▓▒▒▒▒▒▒▒▒▓▓▓█████████████▓▓▓██▓▓█▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░▒▒
// ▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓▒▒▒▒▒▓▓▓▓▒▒▒▓▓▓▓▓▓▓▓████████▓▓▓▓▓▓▓▓▓██████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒░▒▒
// ▒▒▒▒▒▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓▓▒▒▒▒▒▓▓▓▓▓▒▒▓▓▓▓▓▓▓▓▓████████████████████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒░░░▒▒
// ▒▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▓▒▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▒▒▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓████████████████████████▓▓▓▓▓▓▓█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░░░░░░░░░░▒░
// ▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▓▓▓▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓███████████████████████▓▓▓▓██▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░░░░░░░░░▒░
// ▒▒▒▒▒▒▒▒▒▒▒▒▓▒▒▓▒▒▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▓▓▓▓▓▓▓▓▓▓████████████████████▓▓▓▓▓▓███▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░░░░░░░░░
// ▒▒▒▒▒▒▒▒▓▓▒▒▓▓▓▓▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓███████████████▓▓▓▓▓████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░░░░░░░▒
// ▒▒▒▒▒▒▒▓▓▓▒▒▒▓▓▓▓▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓██████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░░░░░░▒
// ░░░░░░▒▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▒▒▒▓▓▓▓▓▓▓▓▓███████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░▒▒
// ░░░░░░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░▒▒
// ░░░░░░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░░▒▒▒
// ░░░░░░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█▓▓▓▓▓▓▓▓▓▓▓▒░▒▒▒
// ░░░░░░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█▓▓▓▓▓▓▓▓▓▓▓▒░▒▒▒
// ░░░░░░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░░░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒
package main

import (
	"flag"
	"fmt"
	"math"
	"os"
	"os/exec"
	"path/filepath"
	"strconv"
	"strings"
)

// acceptable vibes only
var sociallyAcceptableFPS = map[int]bool{
	6:  true, // Khabby lame mechanism
	12: true, // mid
	24: true, // cinema who?
}

// Scale stuff or something, idk
var humbleScales = map[float64]bool{
	1.0:  true, // full quality
	0.5:  true, // we ball but smaller
	0.25: true, // ur future
}

func formatScaleForClout(scale float64) string {
	// idk some math stuff i dont really understand it twin 🥀
	if math.Abs(scale-math.Trunc(scale)) < 1e-9 {
		return strconv.FormatInt(int64(math.Trunc(scale)), 10)
	}
	return strconv.FormatFloat(scale, 'g', -1, 64)
}

func wrapIfSus(s string) string {
	// formating stuff
	if strings.ContainsAny(s, " \t\n'\"") {
		return strconv.Quote(s)
	}
	return s
}

func main() {
	// define the chaos inputs
	inputPath := flag.String("i", "", "input file (required, duh)")
	outputPath := flag.String("o", "", "output file (optional, live a little)")
	fps := flag.Int("fps", 12, "frames per second. choices: 6 (meh), 12 (ok), 24 (fancy)")
	scale := flag.Float64("scale", 0.5, "scale factor. options: 1, 0.5, 0.25")
	flag.Parse()
	if *inputPath == "" {
		fmt.Fprintln(os.Stderr, "🚨 Give me some input or ts pmo fr twin.")
		flag.Usage()
		os.Exit(2)
	}

	// check if ffmpeg exist
	if _, err := exec.LookPath("ffmpeg"); err != nil {
		fmt.Fprintln(os.Stderr, "💀 ffmpeg missing. go install it or cry idk.")
		os.Exit(1)
	}

	// fps sanity check
	if !sociallyAcceptableFPS[*fps] {
		fmt.Fprintf(os.Stderr, "nah fam %d fps ain't valid. pick 6, 12, or 24 like a normal person.\n", *fps)
		os.Exit(2)
	}

	// scale sanity check
	if !humbleScales[*scale] {
		fmt.Fprintf(os.Stderr, "scale %v?? that’s not on the menu. try 1, 0.5, or 0.25.\n", *scale)
		os.Exit(2)
	}

	// auto name the file if user can’t commit
	finalOutput := *outputPath
	if strings.TrimSpace(finalOutput) == "" {
		base := filepath.Base(*inputPath)
		ext := filepath.Ext(base)
		name := strings.TrimSuffix(base, ext)
		scaleStr := formatScaleForClout(*scale)
		finalOutput = fmt.Sprintf("%s_%sx_%dfps.webp", name, scaleStr, *fps)
	}

	// concoct ffmpeg filter like a mad scientist
	scaleStr := formatScaleForClout(*scale)
	ffFilter := fmt.Sprintf("fps=%d,scale=iw*%s:ih*%s:flags=lanczos", *fps, scaleStr, scaleStr)

	// build the ffmpeg ritual
	ritual := []string{
		"-i", *inputPath,
		"-vf", ffFilter,
		"-loop", "0",
		"-qscale", "80",
		"-preset", "picture",
		finalOutput,
	}

	// announce to the world what chaos is about to happen
	prettyArgs := make([]string, len(ritual))
	for i, arg := range ritual {
		prettyArgs[i] = wrapIfSus(arg)
	}
	fmt.Println("\n🎬 okay we’re running this command fr:")
	fmt.Println("ffmpeg", strings.Join(prettyArgs, " "))
	fmt.Println()

	cmd := exec.Command("ffmpeg", ritual...)
	cmd.Stdout = os.Stdout
	cmd.Stderr = os.Stderr

	if err := cmd.Run(); err != nil {
		fmt.Fprintf(os.Stderr, "\n❌ ffmpeg gave up in u twin: %v\n", err)
		os.Exit(1)
	}

	// check if we actually made something
	if _, err := os.Stat(finalOutput); err == nil {
		fmt.Printf("\n✅ slay. output saved as: %s\n", finalOutput)
		os.Exit(0)
	} else if os.IsNotExist(err) {
		fmt.Fprintf(os.Stderr, "\n❌ ffmpeg ghosted us.\n")
		os.Exit(1)
	} else {
		fmt.Fprintf(os.Stderr, "\n❌ idk man something weird happened: %v\n", err)
		os.Exit(1)
	}

}
